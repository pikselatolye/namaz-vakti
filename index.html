<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Ankara Namaz Vakitleri</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Namaz Vakti">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no">
  <meta name="format-detection" content="date=no">
  <meta name="format-detection" content="address=no">
  <meta name="format-detection" content="email=no">

  <style>
    :root{
      --text:#f5f8ff;
      --muted:rgba(255,255,255,.76);
      --border:rgba(255,255,255,.16);
      --glass:rgba(255,255,255,.075);
      --accent:#7aa2ff;
      --accent2:#8dffa8;
      --warn:#ffcc66;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }

    html, body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      overflow:hidden;
      -webkit-text-size-adjust:100%;
      text-rendering:optimizeLegibility;
      background:#050914;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    body.theme-day{
      background:
        radial-gradient(circle at 18% 10%, rgba(122,162,255,.38), transparent 42%),
        radial-gradient(circle at 85% 6%, rgba(141,255,168,.22), transparent 45%),
        radial-gradient(circle at 70% 90%, rgba(255,204,102,.10), transparent 45%),
        linear-gradient(180deg,#0a1530 0%,#050914 100%);
    }
    body.theme-night{
      background:
        radial-gradient(circle at 15% 10%, rgba(122,162,255,.22), transparent 45%),
        radial-gradient(circle at 88% 0%, rgba(122,162,255,.10), transparent 55%),
        linear-gradient(180deg,#050914 0%,#02040a 100%);
    }

    body:before{
      content:"";
      position:fixed;
      left:0; right:0; bottom:-10px;
      height:55%;
      opacity:.10;
      pointer-events:none;
      background-repeat:no-repeat;
      background-position:center bottom;
      background-size:cover;
      background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 400'>\
  <defs>\
    <linearGradient id='g' x1='0' x2='0' y1='0' y2='1'>\
      <stop offset='0' stop-color='%23ffffff' stop-opacity='0.00'/>\
      <stop offset='1' stop-color='%23ffffff' stop-opacity='0.40'/>\
    </linearGradient>\
  </defs>\
  <g fill='url(%23g)'>\
    <rect x='0' y='310' width='1200' height='90'/>\
    <path d='M330 310c0-95 78-170 175-170s175 75 175 170H330z'/>\
    <rect x='380' y='200' width='250' height='110' rx='10'/>\
    <rect x='505' y='150' width='6' height='50'/>\
    <circle cx='508' cy='140' r='12'/>\
    <path d='M120 310c0-55 45-100 100-100s100 45 100 100H120z'/>\
    <rect x='170' y='240' width='100' height='70' rx='10'/>\
    <path d='M880 310c0-55 45-100 100-100s100 45 100 100H880z'/>\
    <rect x='930' y='240' width='100' height='70' rx='10'/>\
    <path d='M60 310V120h50l10 30v160H60z'/>\
    <path d='M1090 310V120h50l10 30v160h-60z'/>\
    <rect x='72' y='105' width='26' height='15' rx='3'/>\
    <rect x='1102' y='105' width='26' height='15' rx='3'/>\
  </g>\
</svg>");
    }

    .topbar{
      height:8px;
      background:linear-gradient(90deg, rgba(122,162,255,.98), rgba(141,255,168,.92), rgba(255,204,102,.92));
      opacity:.9;
    }

    .wrap{
      height:calc(100% - 8px);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      border:1px solid var(--border);
      border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.20));
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }

    .header{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      min-height:78px;
    }
    .title{
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      font-size:13px;
      color:var(--muted);
      line-height:1.25;
    }
    .metaRow{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(255,255,255,.82);
      white-space:nowrap;
    }
    .dot{
      display:inline-block;
      width:8px;height:8px;border-radius:99px;
      background:var(--accent);
      margin-right:7px;
      box-shadow:0 0 0 3px rgba(122,162,255,.14);
      vertical-align:middle;
    }
    .clock{
      font-size:54px;
      font-weight:900;
      letter-spacing:1px;
      line-height:1;
      font-variant-numeric:tabular-nums;
      text-shadow:0 3px 18px rgba(0,0,0,.45);
      min-width:132px;
      text-align:right;
    }

    .next{
      padding:10px 14px;
      border-radius:20px;
      background:linear-gradient(180deg, rgba(122,162,255,.18), rgba(0,0,0,.22));
      border:1px solid rgba(255,255,255,.14);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      min-height:54px;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .nextPrayer{
      margin-top:3px;
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .countdown{
      font-size:22px;
      font-weight:900;
      font-variant-numeric:tabular-nums;
      text-shadow:0 3px 18px rgba(0,0,0,.45);
      text-align:right;
    }

    .tilesCard{
      flex:1;
      min-height:0;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .tilesWrap{
      flex:1;
      min-height:0;
      display:flex;
      flex-wrap:wrap;
      align-content:stretch;
      margin:-6px;
    }
    .tile{
      width:50%;
      height:33.3333%;
      padding:6px;
    }

    .tileInner{
      height:100%;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      box-shadow:0 14px 34px rgba(0,0,0,.40);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:18px 18px;
      position:relative;
      overflow:hidden;
    }
    .tileInner:after{
      content:"";
      position:absolute;
      left:-40px; top:-40px;
      width:180px; height:180px;
      background:radial-gradient(circle at 30% 30%, rgba(122,162,255,.22), transparent 60%);
      transform:rotate(18deg);
      pointer-events:none;
    }

    .tname{
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
      color:rgba(255,255,255,.92);
    }
    .ttime{
      font-size:50px;
      font-weight:900;
      letter-spacing:1px;
      line-height:1;
      font-variant-numeric:tabular-nums;
      text-shadow:0 3px 18px rgba(0,0,0,.45);
    }

    @keyframes pulseGlow{
      0%   { box-shadow:0 0 0 rgba(122,162,255,.0), 0 14px 34px rgba(0,0,0,.40); }
      50%  { box-shadow:0 0 34px rgba(122,162,255,.55), 0 16px 40px rgba(0,0,0,.48); }
      100% { box-shadow:0 0 0 rgba(122,162,255,.0), 0 14px 34px rgba(0,0,0,.40); }
    }
    .active .tileInner{
      border-color:rgba(122,162,255,.80);
      background:linear-gradient(180deg, rgba(122,162,255,.22), rgba(0,0,0,.18));
      animation:pulseGlow 2.2s ease-in-out infinite;
    }

    .err{
      font-size:12px;
      color:rgba(255,190,190,.98);
      font-weight:800;
      padding:0 2px;
    }

    .footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:0 2px;
      color:rgba(255,255,255,.58);
      font-size:11px;
      line-height:1.2;
      min-height:16px;
    }
    .rightFooter{ white-space:nowrap; }

    /* ===== VAKİT GİRDİ OVERLAY ===== */
    .overlay{
      position:fixed;
      left:0; top:0; right:0; bottom:0;
      display:none;
      z-index:9999;
      padding:22px;
      background:rgba(0,0,0,.72);
    }
    .overlay.show{ display:block; }

    .ovCard{
      height:100%;
      border-radius:26px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 25% 20%, rgba(122,162,255,.30), transparent 45%),
        radial-gradient(circle at 85% 15%, rgba(141,255,168,.18), transparent 50%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.35));
      box-shadow:0 22px 55px rgba(0,0,0,.65);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:24px;
    }
    .ovSmall{
      font-size:16px;
      color:rgba(255,255,255,.80);
      font-weight:800;
      letter-spacing:.3px;
    }
    .ovBig{
      margin-top:10px;
      font-size:74px;
      font-weight:900;
      letter-spacing:.6px;
      text-shadow:0 4px 30px rgba(0,0,0,.55);
    }
    .ovTime{
      margin-top:10px;
      font-size:34px;
      font-weight:900;
      color:rgba(255,255,255,.90);
      font-variant-numeric:tabular-nums;
    }
    .ovHint{
      margin-top:18px;
      font-size:14px;
      color:rgba(255,255,255,.62);
      font-weight:700;
    }
  </style>
</head>

<body class="theme-night">
  <div class="topbar"></div>

  <div class="wrap">
    <div class="card header">
      <div style="min-width:0">
        <div class="title">Ankara • Namaz Vakitleri</div>
        <div class="sub" id="dateLine">—</div>
        <div class="metaRow">
          <div class="pill"><span class="dot"></span><span id="districtPill">İlçe: —</span></div>
          <div class="pill" id="srcPill">Kaynak: —</div>
        </div>
      </div>
      <div class="clock" id="clock">--:--</div>
    </div>

    <div class="next">
      <div>
        <div class="label">Sıradaki</div>
        <div class="nextPrayer" id="nextPrayer">—</div>
      </div>
      <div style="text-align:right">
        <div class="label">Kalan</div>
        <div class="countdown" id="countdown">--:--:--</div>
      </div>
    </div>

    <div class="card tilesCard">
      <div class="tilesWrap" id="tilesWrap"></div>
      <div class="err" id="err"></div>
    </div>

    <div class="footer">
      <div id="statusLine">Güncelleme: —</div>
      <div class="rightFooter">© <span id="copyYear"></span> A. Ensar Kibaroğlu</div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay">
    <div class="ovCard">
      <div class="ovSmall">VAKİT GİRDİ</div>
      <div class="ovBig" id="ovPrayer">—</div>
      <div class="ovTime" id="ovTime">--:--</div>
      <div class="ovHint">1 dakika sonra ana ekrana dönülecek…</div>
    </div>
  </div>

<script>
(function(){
  var PRAYERS = [
    { key:"Imsak", tr:"İmsak" },
    { key:"Gunes", tr:"Güneş" },
    { key:"Ogle",  tr:"Öğle"  },
    { key:"Ikindi",tr:"İkindi"},
    { key:"Aksam", tr:"Akşam" },
    { key:"Yatsi", tr:"Yatsı" }
  ];
  var NEXT_ORDER = ["Imsak","Ogle","Ikindi","Aksam","Yatsi"];

  function el(id){ return document.getElementById(id); }
  function pad(n){ n = String(n); return n.length<2 ? "0"+n : n; }
  function fmtClock(d){ return pad(d.getHours()) + ":" + pad(d.getMinutes()); }
  function fmtHMS(ms){
    var s = Math.max(0, Math.floor(ms/1000));
    var hh = Math.floor(s/3600);
    var mm = Math.floor((s%3600)/60);
    var ss = s%60;
    return pad(hh)+":"+pad(mm)+":"+pad(ss);
  }
  function parseHHMM(baseDate, hhmm){
    var parts = String(hhmm||"0:0").split(":");
    var hh = parseInt(parts[0],10) || 0;
    var mm = parseInt(parts[1],10) || 0;
    var d = new Date(baseDate.getTime());
    d.setHours(hh, mm, 0, 0);
    return d;
  }
  function setError(msg){ el("err").textContent = msg || ""; }

  function applyTheme(){
    var h = (new Date()).getHours();
    document.body.className = (h >= 7 && h < 19) ? "theme-day" : "theme-night";
  }

  function getJSON(url, onOk, onErr){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function(){
      if(xhr.readyState !== 4) return;
      if(xhr.status >= 200 && xhr.status < 300){
        try{ onOk(JSON.parse(xhr.responseText)); }
        catch(e){ onErr("JSON parse hatası"); }
      } else {
        onErr("HTTP " + xhr.status);
      }
    };
    xhr.onerror = function(){ onErr("Network error"); };
    xhr.send();
  }

  // Overlay logic
  var overlayTimer = null;
  function showOverlay(prayerTr, timeHHMM){
    var ov = el("overlay");
    el("ovPrayer").textContent = prayerTr;
    el("ovTime").textContent = timeHHMM || "--:--";
    ov.className = "overlay show";

    if(overlayTimer) clearTimeout(overlayTimer);
    overlayTimer = setTimeout(function(){
      ov.className = "overlay";
    }, 60000); // 60 sn
  }

  // Prevent multiple triggers within same day+prayer
  function todayKey(){
    var d = new Date();
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
  }
  function getFiredMap(){
    try{
      var raw = localStorage.getItem("fired_map_v1");
      return raw ? JSON.parse(raw) : {};
    }catch(e){ return {}; }
  }
  function setFiredMap(m){
    try{ localStorage.setItem("fired_map_v1", JSON.stringify(m)); }catch(e){}
  }

  var data = null;

  function renderTiles(){
    if(!data || !data.today){ setError("Veri yok."); return; }
    var t = data.today;

    el("dateLine").textContent = t.MiladiTarihUzun || t.MiladiTarihKisa || "—";
    el("districtPill").textContent = "İlçe: " + (data.district || "ANKARA");
    el("srcPill").textContent = "Kaynak: " + (data.source || "—");
    el("statusLine").textContent = "Güncelleme: " + (data.generatedAt || "—");

    var wrap = el("tilesWrap");
    wrap.innerHTML = "";

    for(var i=0;i<PRAYERS.length;i++){
      var p = PRAYERS[i];
      var time = t[p.key] || "--:--";

      var tile = document.createElement("div");
      tile.className = "tile";
      tile.setAttribute("data-key", p.key);

      var inner = document.createElement("div");
      inner.className = "tileInner";
      inner.innerHTML = '<div class="tname">'+p.tr+'</div><div class="ttime">'+time+'</div>';

      tile.appendChild(inner);
      wrap.appendChild(tile);
    }
    setError("");
  }

  function updateLive(){
    applyTheme();

    var now = new Date();
    el("clock").textContent = fmtClock(now);
    if(!data || !data.today) return;

    var t = data.today;

    // Find next prayer (and time) based on NEXT_ORDER
    var next = null, i, k, at;
    for(i=0;i<NEXT_ORDER.length;i++){
      k = NEXT_ORDER[i];
      at = parseHHMM(now, t[k]);
      if(at.getTime() > now.getTime()){ next = { k:k, at:at, time:t[k] }; break; }
    }
    if(!next){
      var tmr = new Date(now.getTime());
      tmr.setDate(tmr.getDate()+1);
      next = { k:"Imsak", at: parseHHMM(tmr, t["Imsak"]), time:t["Imsak"] };
    }

    // label: “İkindi • 15:58”
    var nameTr = next.k;
    for(i=0;i<PRAYERS.length;i++){ if(PRAYERS[i].key === next.k){ nameTr = PRAYERS[i].tr; break; } }
    el("nextPrayer").textContent = nameTr + " • " + (next.time || "--:--");
    el("countdown").textContent = fmtHMS(next.at.getTime() - now.getTime());

    // highlight next tile
    var tiles = document.querySelectorAll(".tile");
    for(i=0;i<tiles.length;i++){ tiles[i].className = tiles[i].className.replace(" active",""); }
    var node = document.querySelector('.tile[data-key="'+next.k+'"]');
    if(node) node.className += " active";

    // ===== “vakit girdi” tetikleme =====
    // Her vakit için, tam o dakikaya gelince (hh:mm:00–:02 aralığı) bir kez tetikler.
    var fired = getFiredMap();
    var day = todayKey();

    for(i=0;i<PRAYERS.length;i++){
      var p = PRAYERS[i];
      var hhmm = t[p.key];
      if(!hhmm) continue;

      var d0 = parseHHMM(now, hhmm);
      var diff = Math.abs(now.getTime() - d0.getTime());

      // Saat tam geldiği anda, iOS timer gecikmeleri için 2.5sn tolerans
      if(diff <= 2500){
        var key = day + "|" + p.key;
        if(!fired[key]){
          fired[key] = 1;
          setFiredMap(fired);
          showOverlay(p.tr, hhmm);
        }
      }
    }
  }

  // Init
  el("copyYear").textContent = String((new Date()).getFullYear());
  applyTheme();

  setError("Yükleniyor...");
  getJSON("vakit.json", function(j){
    data = j;
    renderTiles();
    updateLive();
    setInterval(updateLive, 1000);
  }, function(err){
    setError("Veri alınamadı: " + err + " (vakit.json)");
  });
})();
</script>
</body>
</html>
