<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Ankara Namaz Vakitleri</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    :root {
      --text: #f5f8ff;
      --muted: rgba(255, 255, 255, .7);
      --border: rgba(255, 255, 255, .15);
      --accent: #7aa2ff;
      --accent2: #8dffa8;
      --warn: #ffcc66;
      --danger: #ff6b6b;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
      margin: 0;
      color: var(--text);
      overflow: hidden;
      background: #050914;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Temalar */
    body.theme-day {
      background: radial-gradient(circle at 18% 10%, rgba(122,162,255,.3), transparent 40%),
                  linear-gradient(180deg, #0a1530 0%, #050914 100%);
    }
    body.theme-night {
      background: radial-gradient(circle at 15% 10%, rgba(122,162,255,.15), transparent 45%),
                  linear-gradient(180deg, #050914 0%, #02040a 100%);
    }

    .wrap {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 20px;
      background: rgba(255, 255, 255, .05);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* Header */
    .header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title-area h1 { font-size: 20px; margin: 0; font-weight: 800; }
    .title-area p { font-size: 12px; margin: 4px 0 0; color: var(--muted); }
    .clock { font-size: 48px; font-weight: 900; font-variant-numeric: tabular-nums; }

    .pills { display: flex; gap: 6px; margin-top: 8px; }
    .pill { font-size: 10px; padding: 4px 8px; border-radius: 20px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); }
    .pill.kerahat { background: rgba(255, 107, 107, 0.2); border-color: var(--danger); color: var(--danger); font-weight: bold; display: none; }

    /* Sıradaki Vakit */
    .next-vakit {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, rgba(122,162,255,0.1), transparent);
    }
    .next-label { font-size: 11px; font-weight: 800; color: var(--muted); text-transform: uppercase; }
    .next-name { font-size: 24px; font-weight: 900; }
    .countdown { font-size: 28px; font-weight: 900; color: var(--accent2); font-variant-numeric: tabular-nums; }

    /* Kutular (Tiles) */
    .tiles-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 10px;
      flex: 1;
    }
    .tile {
      padding: 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .tile.active {
      border-color: var(--accent);
      background: rgba(122, 162, 255, 0.15);
      box-shadow: 0 0 20px rgba(122, 162, 255, 0.2);
    }
    .t-name { font-size: 14px; color: var(--muted); font-weight: 700; }
    .t-time { font-size: 36px; font-weight: 900; margin-top: 4px; }

    /* Overlay */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9);
      display: none; z-index: 100; flex-direction: column;
      align-items: center; justify-content: center; text-align: center;
    }
    .overlay.show { display: flex; }
    .ov-title { font-size: 18px; color: var(--accent); letter-spacing: 2px; }
    .ov-name { font-size: 80px; font-weight: 900; margin: 20px 0; }

    @media (orientation: portrait) {
      .tiles-grid { grid-template-columns: 1fr; grid-template-rows: repeat(6, 1fr); }
      .t-time { font-size: 42px; }
    }
  </style>
</head>
<body class="theme-night">

  <div class="wrap">
    <div class="card header">
      <div class="title-area">
        <h1>Ankara</h1>
        <p id="dateLine">-- Şubat 2026</p>
        <div class="pills">
          <span class="pill" id="statusPill">Yükleniyor...</span>
          <span class="pill kerahat" id="kerahatPill">⚠ KERAHAT VAKTİ</span>
        </div>
      </div>
      <div class="clock" id="clock">00:00</div>
    </div>

    <div class="card next-vakit" id="nextCard">
      <div>
        <div class="next-label">Sıradaki Vakit</div>
        <div class="next-name" id="nextName">--</div>
      </div>
      <div style="text-align: right;">
        <div class="next-label">Kalan Süre</div>
        <div class="countdown" id="countdown">00:00:00</div>
      </div>
    </div>

    <div class="tiles-grid" id="tilesGrid">
      </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="ov-title">VAKİT GİRDİ</div>
    <div class="ov-name" id="ovName">AKŞAM</div>
    <div style="color: var(--muted);">Aziz Allah...</div>
  </div>

<script>
(function(){
  const PRAYERS = [
    { key:"Imsak", tr:"İmsak" }, { key:"Gunes", tr:"Güneş" }, { key:"Ogle", tr:"Öğle" },
    { key:"Ikindi", tr:"İkindi" }, { key:"Aksam", tr:"Akşam" }, { key:"Yatsi", tr:"Yatsı" }
  ];

  let state = { data: null, lastMinute: -1 };

  const el = id => document.getElementById(id);
  const pad = n => String(n).padStart(2, '0');

  // Vakti Date objesine çevir (Gece yarısı kontrolü ile)
  function parseTime(timeStr, baseDate = new Date()) {
    if(!timeStr) return new Date();
    const [h, m] = timeStr.split(':').map(Number);
    const d = new Date(baseDate);
    d.setHours(h, m, 0, 0);
    return d;
  }

  function loadData() {
    // Netlify cache önlemek için timestamp ekliyoruz
    fetch(`vakit.json?v=${new Date().getTime()}`)
      .then(r => r.json())
      .then(json => {
        state.data = json;
        localStorage.setItem('cached_vakit', JSON.stringify(json));
        init();
      })
      .catch(() => {
        const cached = localStorage.getItem('cached_vakit');
        if(cached) {
          state.data = JSON.parse(cached);
          el('statusPill').textContent = "Çevrimdışı Mod";
          init();
        } else {
          el('statusPill').textContent = "Veri Hatası!";
        }
      });
  }

  function init() {
    renderTiles();
    update();
    setInterval(update, 1000);
  }

  function renderTiles() {
    el('tilesGrid').innerHTML = PRAYERS.map(p => `
      <div class="card tile" id="tile-${p.key}">
        <div class="t-name">${p.tr}</div>
        <div class="t-time">${state.data.today[p.key]}</div>
      </div>
    `).join('');
    el('dateLine').textContent = state.data.today.MiladiTarihUzun || "";
    if(el('statusPill').textContent === "Yükleniyor...") el('statusPill').textContent = "Güncel";
  }

  function update() {
    const now = new Date();
    const currentMin = now.getMinutes();

    // Saniye başı: Saat ve Geri Sayım
    el('clock').textContent = pad(now.getHours()) + ":" + pad(now.getMinutes());
    updateCountdown(now);

    // Dakika başı: Kerahat, Tema ve Overlay
    if (currentMin !== state.lastMinute) {
      checkSpecialStates(now);
      state.lastMinute = currentMin;
    }
  }

  function updateCountdown(now) {
    const times = state.data.today;
    let next = null;

    // Sıradaki vakti bul (Güneş hariç namaz vakitleri)
    const order = ["Imsak", "Ogle", "Ikindi", "Aksam", "Yatsi"];
    for (let key of order) {
      let t = parseTime(times[key]);
      if (t > now) { next = { k: key, t: t }; break; }
    }

    // Gece yarısından sonra Yatsı bittiyse yarına geç
    if (!next) {
      let tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      next = { k: "Imsak", t: parseTime(times.Imsak, tomorrow) };
    }

    const diff = next.t - now;
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    
    el('countdown').textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
    const trName = PRAYERS.find(p => p.key === next.k).tr;
    el('nextName').textContent = trName + " • " + times[next.k];

    // Aktif kutuyu ışıklandır
    PRAYERS.forEach(p => el(`tile-${p.key}`).classList.remove('active'));
    el(`tile-${next.k}`).classList.add('active');
  }

  function checkSpecialStates(now) {
    const t = state.data.today;
    
    // Tema Değişimi
    const hour = now.getHours();
    document.body.className = (hour >= 7 && hour < 19) ? "theme-day" : "theme-night";

    // Kerahat Kontrolü (Güneş doğunca +45dk, Akşama -45dk)
    const gunes = parseTime(t.Gunes);
    const aksam = parseTime(t.Aksam);
    const isKerahat = (now > gunes && now < new Date(gunes.getTime() + 45*60000)) || 
                      (now > new Date(aksam.getTime() - 45*60000) && now < aksam);
    el('kerahatPill').style.display = isKerahat ? "inline-block" : "none";

    // Overlay (Vakit girdiğinde 1 dk göster)
    const timeStr = pad(now.getHours()) + ":" + pad(now.getMinutes());
    PRAYERS.forEach(p => {
      if(t[p.key] === timeStr) {
        el('ovName').textContent = p.tr;
        el('overlay').classList.add('show');
        setTimeout(() => el('overlay').classList.remove('show'), 60000);
      }
    });
  }

  loadData();
})();
</script>
</body>
</html>
